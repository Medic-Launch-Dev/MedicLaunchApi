using System.Text.Json;
using MedicLaunchApi.Models.ViewModels;
using MedicLaunchApi.Repository;
using MedicLaunchApi.Models.OpenAI;

namespace MedicLaunchApi.Services
{
	public class TextbookLessonGenerationService
	{
		private readonly OpenAIService openAIService;

		public TextbookLessonGenerationService(OpenAIService openAIService)
		{
			this.openAIService = openAIService;
		}

		private List<ChatMessage> ConstructChatPrompt(string htmlContent)
		{
			var messages = new List<ChatMessage>();

			var systemMessage = "Convert provided HTML medical data into a structured JSON object following a specific format, preserving all HTML formatting within the text while extracting clear headings and a title. If any heading is unclear or missing, generate an appropriate heading based on the content context. If the title is unclear or missing, generate an appropriate title based on the context of all the content.\n\n# Steps\n\n1. **Extract Title**: Identify and extract the title, which is typically found in the initial `<h3>` or similar structure. The title should include only text, without HTML tags.\n2. **Identify Sections**: Split the content into sections based on identifiable headings such as `<strong>` tags, `<li><p><strong>`, or contextual clues from the data.\n3. **Generate Missing Headings**: If any text lacks a heading, create an appropriate one based on the context.\n4. **Preserve HTML**: For each section's text content, preserve HTML formatting exactly as presented in the input.\n5. **Construct JSON**: Organize the extracted data into the JSON structure provided, ensuring the following elements:\n   - `\"title\"`: Plain-text title.\n   - `\"contents\"`: An array of objects where each object contains:\n     - `\"heading\"`: Plain-text section heading.\n     - `\"text\"`: HTML content for the section.\n6. **Output JSON**: Return the final JSON object strictly adhering to the format described.\n\n# Output Format\n\nThe output should strictly adhere to the following JSON structure:\n\n{\n  \"title\": \"[Title extracted from input, plain-text]\",\n  \"contents\": [\n    {\n      \"heading\": \"[Section heading, plain-text]\",\n      \"text\": \"[HTML content for this section]\"\n    },\n    ...\n  ]\n}\n\nEnsure all placeholders like `[Title extracted from input, plain-text]` and `[HTML content for this section]` are replaced with actual extracted data from the provided input.\n\n# Examples\n\n**Example Input**:\n<h3><strong>Opioid Withdrawal</strong></h3><p></p><ul><li><p><strong>Definition</strong>: A syndrome resulting from cessation or reduction of prolonged opioid use.</p></li></ul><p></p><ul><li><p><strong>Clinical Features</strong>:</p><ul><li><p><strong>Early</strong>: Anxiety, yawning, sweating, lacrimation.</p></li><li><p><strong>Late</strong>: Dilated pupils, vomiting, diarrhoea, tachycardia, muscle cramps.</p></li><li><p><strong>Severe</strong>: Piloerection (\"goosebumps\"), hypertension.</p></li></ul></li><li><p><strong>Management</strong>:</p><ul><li><p><strong>Symptomatic treatment</strong>: NSAIDs for muscle cramps, loperamide for diarrhoea.</p></li><li><p><strong>Medications</strong>:</p><ul><li><p><strong>Methadone or buprenorphine</strong>: Opioid agonist therapy for withdrawal reduction.</p></li><li><p><strong>Clonidine</strong>: For autonomic symptoms (sweating, tachycardia).</p></li><li><p><strong>Adjuncts</strong>: Anti-emetics, benzodiazepines for anxiety.</p></li></ul></li></ul></li></ul>\n\n**Example Output**:\n{\n  \"title\": \"Opioid Withdrawal\",\n  \"contents\": [\n    {\n      \"heading\": \"Definition\",\n      \"text\": \"<p>A syndrome resulting from cessation or reduction of prolonged opioid use.</p>\"\n    },\n    {\n      \"heading\": \"Clinical Features\",\n      \"text\": \"<ul><li><p><strong>Early</strong>: Anxiety, yawning, sweating, lacrimation.</p></li><li><p><strong>Late</strong>: Dilated pupils, vomiting, diarrhoea, tachycardia, muscle cramps.</p></li><li><p><strong>Severe</strong>: Piloerection (\\\"goosebumps\\\"), hypertension.</p></li></ul>\"\n    },\n    {\n      \"heading\": \"Management\",\n      \"text\": \"<ul><li><p><strong>Symptomatic treatment</strong>: NSAIDs for muscle cramps, loperamide for diarrhoea.</p></li><li><p><strong>Medications</strong>:</p><ul><li><p><strong>Methadone or buprenorphine</strong>: Opioid agonist therapy for withdrawal reduction.</p></li><li><p><strong>Clonidine</strong>: For autonomic symptoms (sweating, tachycardia).</p></li><li><p><strong>Adjuncts</strong>: Anti-emetics, benzodiazepines for anxiety.</p></li></ul></li></ul>\"\n    }\n  ]\n}\n\n**Notes**:\n- In case the input format is inconsistent (e.g., missing HTML tags), or unfamiliar, aim to adapt and infer as much of the structure as possible while prioritizing consistency in output format.\n- Avoid adding any content not present in the input, other than necessary generated headings.\n- In case there is no clear title to be extracted, infer an appropriate title based on the rest of the content.\n- For the content, make sure you do not repeat the heading in the text. So for example, you should not have \"Body Weight\" as the heading, and then have \"<ul><li><p><strong>Body Weight</strong>: People with bulimia often maintain a normal body weight, but it may fluctuate.</p></li></ul>\". In this case, it is ok to change the text content to the following: \"<ul><li><p>People with bulimia often maintain a normal body weight, but it may fluctuate.</p></li></ul>\"";
			messages.Add(new ChatMessage { Role = "system", Content = [new ChatContent { Text = systemMessage }] });
			var example1UserMessage = "<h3><strong><span style=\"color: rgb(0, 0, 0)\">Molluscum Contagiosum</span></strong></h3><p></p><p><strong><span style=\"color: rgb(0, 0, 0)\">Overview:<br></span></strong><span style=\"color: rgb(0, 0, 0)\">Molluscum contagiosum is a common viral skin infection caused by the </span><em><span style=\"color: rgb(0, 0, 0)\">Molluscum contagiosum virus</span></em><span style=\"color: rgb(0, 0, 0)\"> (MCV). It often affects children and is typically self-limiting.</span></p><p></p><p><strong><span style=\"color: rgb(0, 0, 0)\">Clinical Features:</span></strong></p><ul><li><p><strong><span style=\"color: rgb(0, 0, 0)\">Pearly, dome-shaped papules</span></strong><span style=\"color: rgb(0, 0, 0)\"> with central umbilication.</span></p></li><li><p><span style=\"color: rgb(0, 0, 0)\">Commonly affects the trunk, face, and extremities.</span></p></li><li><p><span style=\"color: rgb(0, 0, 0)\">Typically asymptomatic, but can cause mild itching.</span></p></li></ul><p></p><p><strong><span style=\"color: rgb(0, 0, 0)\">Diagnosis:</span></strong></p><ul><li><p><span style=\"color: rgb(0, 0, 0)\">Clinical diagnosis based on characteristic lesions.</span></p></li></ul><p></p><p><strong><span style=\"color: rgb(0, 0, 0)\">Management:</span></strong></p><ul><li><p><strong><span style=\"color: rgb(0, 0, 0)\">Reassurance and observation</span></strong><span style=\"color: rgb(0, 0, 0)\">: The condition is usually self-limiting and resolves within 6–12 months.</span></p></li><li><p><strong><span style=\"color: rgb(0, 0, 0)\">Treatment options</span></strong><span style=\"color: rgb(0, 0, 0)\"> (if desired): Cryotherapy, topical agents (e.g. salicylic acid), or curettage for persistent cases.</span></p></li><li><p><span style=\"color: rgb(0, 0, 0)\">Avoid sharing towels and close contact to prevent spread.</span></p></li></ul>";
			messages.Add(new ChatMessage { Role = "user", Content = [new ChatContent { Text = example1UserMessage }] });
			var example1AssistantMessage = "{\n  \"title\": \"Molluscum Contagiosum\",\n  \"contents\": [\n    {\n      \"heading\": \"Overview\",\n      \"text\": \"<p>Molluscum contagiosum is a common viral skin infection caused by the <em>Molluscum contagiosum virus</em> (MCV). It often affects children and is typically self-limiting.</p>\"\n    },\n    {\n      \"heading\": \"Clinical Features\",\n      \"text\": \"<ul><li><p><strong>Pearly, dome-shaped papules</strong> with central umbilication.</p></li><li><p>Commonly affects the trunk, face, and extremities.</p></li><li><p>Typically asymptomatic, but can cause mild itching.</p></li></ul>\"\n    },\n    {\n      \"heading\": \"Diagnosis\",\n      \"text\": \"<ul><li><p>Clinical diagnosis based on characteristic lesions.</p></li></ul>\"\n    },\n    {\n      \"heading\": \"Management\",\n      \"text\": \"<ul><li><p><strong>Reassurance and observation</strong>: The condition is usually self-limiting and resolves within 6–12 months.</p></li><li><p><strong>Treatment options</strong> (if desired): Cryotherapy, topical agents (e.g. salicylic acid), or curettage for persistent cases.</p></li><li><p>Avoid sharing towels and close contact to prevent spread.</p></li></ul>\"\n    }\n  ]\n}";
			messages.Add(new ChatMessage { Role = "assistant", Content = [new ChatContent { Text = example1AssistantMessage }] });
			var example2UserMessage = "<ul><li><p>Colles' fractures often occur due to a <strong>fall onto the outstretched hand</strong>, leading to dorsal displacement and radial deviation of the fractured bone.</p></li></ul><p></p><ul><li><p><strong>Symptoms</strong>: pain, swelling, and an obvious deformity at the wrist. There may also be limited wrist movement and tenderness.</p></li></ul><p></p><ul><li><p><strong>X-rays</strong> confirm the diagnosis, assess the degree of displacement, and guide management decisions.</p></li></ul><p></p><ul><li><p><strong>Management </strong>options include closed reduction and immobilisation with a cast or splint, or surgical intervention in complex or unstable fractures.</p></li></ul>";
			messages.Add(new ChatMessage { Role = "user", Content = [new ChatContent { Text = example2UserMessage }] });
			var example2AssistantMessage = "{\n  \"title\": \"Colles' Fractures\",\n  \"contents\": [\n    {\n      \"heading\": \"Overview\",\n      \"text\": \"<ul><li><p>Colles' fractures often occur due to a <strong>fall onto the outstretched hand</strong>, leading to dorsal displacement and radial deviation of the fractured bone.</p></li></ul>\"\n    },\n    {\n      \"heading\": \"Symptoms\",\n      \"text\": \"<ul><li><p>Symptoms include pain, swelling, and an obvious deformity at the wrist. There may also be limited wrist movement and tenderness.</p></li></ul>\"\n    },\n    {\n      \"heading\": \"Diagnosis\",\n      \"text\": \"<ul><li><p>X-rays confirm the diagnosis, assess the degree of displacement, and guide management decisions.</p></li></ul>\"\n    },\n    {\n      \"heading\": \"Management\",\n      \"text\": \"<ul><li><p>Management options include closed reduction and immobilisation with a cast or splint, or surgical intervention in complex or unstable fractures.</p></li></ul>\"\n    }\n  ]\n}";
			messages.Add(new ChatMessage { Role = "assistant", Content = [new ChatContent { Text = example2AssistantMessage }] });

			messages.Add(new ChatMessage { Role = "user", Content = [new ChatContent { Text = htmlContent }] });

			return messages;
		}

		public async Task<CreateTextbookLessonRequest> GenerateTextbookLessonAsync(string htmlContent, string specialityId, string? questionId)
		{
			var messages = ConstructChatPrompt(htmlContent);
			var response = await openAIService.GenerateChatCompletion(messages: messages, modelName: "gpt-4o");

			JsonSerializerOptions jsonOptions = new() { PropertyNamingPolicy = JsonNamingPolicy.CamelCase };
			var createTextbookLessonRequest = JsonSerializer.Deserialize<CreateTextbookLessonRequest>(response, jsonOptions);

			if (createTextbookLessonRequest == null)
			{
				throw new Exception("Failed to deserialize the response from OpenAI.");
			}

			createTextbookLessonRequest.SpecialityId = specialityId;
			createTextbookLessonRequest.QuestionId = questionId;
			// createTextbookLessonRequest.SpecialityId = specialityId;
			// var textbookLessonId = await textbookLessonRepository.CreateTextbookLessonAsync(createTextbookLessonRequest, userId);

			return createTextbookLessonRequest;
		}
	}
}
